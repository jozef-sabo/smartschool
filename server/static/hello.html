<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://canvasjs.com/assets/script/jquery-1.11.1.min.js"></script>
    <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
    <title>Document</title>
</head>
<body>
    <html>
    <button onclick="candle()">Show Candle</button>
    <button onclick="line()">Show Line</button>

    <div id="chartTemp" style="height: 300px; width: 100%;"></div>
    <div id="chartHumid" style="height: 300px; width: 100%;"></div>
    <div id="chartDP" style="height: 300px; width: 100%;"></div>
    <div id="chartA0" style="height: 300px; width: 100%;"></div>

    <script>
    function candle() {
        var data;

        $.ajax({
        url: 'http://192.168.0.105/api/Candle',
        type: "GET",
        dataType: "json",
        success: function (data) {
            console.log("Success");
            for (var idx = 0; idx < 4; idx++){
              drawCandle(data[idx], idx);
            }
        },
        error: function () {
            console.log("Error!");
        }
      });
      return data; 

    }

    function line() {
      var data;
      $.ajax({
        url: 'http://192.168.0.105/api/Line',
        type: "GET",
        dataType: "json",
        success: function (data) {
            console.log("Success");
            for (var idx = 0; idx < 4; idx++){
              drawLine(data[0][idx], idx, data[1][idx]);
            }

        },
        error: function () {
            console.log("Error!");
        }
      });
      return data;
    }

    function drawCandle(data, idx) {
      // console.log(createDatapoints(y));
      sensor = selectSensorType(idx);
      var chart = new CanvasJS.Chart(sensor[0], {
	      animationEnabled: true,
	      theme: "light2", // "light1", "light2", "dark1", "dark2"
	      exportEnabled: true,
	      title: {
		      text: sensor[1],
	      },
	      subtitles: [{
		      text: "Hourly Candles"
	      }],
	      axisY: {
		      // title: "Temp",
	      },
	      toolTip: {
          shared: false,
		      content: "Hour: {x}<br /><strong>Values:</strong><br />Open: {y[0]}, Close: {y[3]}<br />High: {y[1]}, Low: {y[2]}"
	      },
	      data: [{
		      type: "candlestick",
          xValueType: "int",
		      dataPoints: createDatapoints(data),
          fallingColor: 'grey',
          risingColor: 'white',
	      },
        {
		      type: "spline",
		      dataPoints: createOHLCpoints(data, 3), //0 - open, 1 - high, 2 - low, 3 - close
          markerType: 'none',
	      },
        // {
		    //   type: "spline",
		    //   dataPoints: createOHLCpoints(y, 0)
	      // }
        ]
      });

      function createOHLCpoints(data, x){
        var dataPoints = [];
        for (var i = 0; i < data.length; i++){
          dataPoints.push(
            {
              x: data[i][0],
              y: data[i][1][x]
            }
          )
        }
        return dataPoints
      };
      chart.render();
    };
    
    function drawLine(data, idx, avg){

      sensor = selectSensorType(idx);
      var chart = new CanvasJS.Chart(sensor[0], {
	      animationEnabled: true,  
	      title:{
		      text: sensor[1],
	      },
	      axisY: {
		      stripLines: [{
			    value: avg,
			    label: "Average"
		      }],
          minimum: 0
	      },
	      data: [{
		      type: "spline",
		      dataPoints: createDatapoints(data),
	      }]
      });
    chart.render();
    }

    function selectSensorType(idx) {
      if (idx == 0) {
        ch = "chartTemp";
        title = 'Temperature';
      }
      if (idx == 1) {
        ch = "chartHumid";
        title = "Humidity";
      }
      if (idx == 2) {
        ch = "chartDP";
        title = "Dew Point";
      }
      if (idx == 3) {
        ch = "chartA0";
        title = "A0";
      }

      return [ch, title]
    } 

    // returns in format [{x1: value1, y1: value1, value2,...},{x2:... , y2:... },...]
    function createDatapoints(data){
        var dataPoints = [];
        for (var i = 0; i < data.length; i++){
          dataPoints.push(
            {
              x: data[i][0],
              y: data[i][1]
            }
          )
        }
        return dataPoints
      }

    </script>

</html>
</body>